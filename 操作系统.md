# 操作系统

## 第1章 导论

### 1.1 操作系统做什么

计算机系统分为四部分：计算机硬件、操作系统、系统程序与应用程序、用户

#### 1.1.1 从用户视角理解操作系统

操作系统设计的目的是为了用户使用方便，**性能是次要的**，而且不在乎资源使用率

操作系统设计为资源使用做了优化：确保所有的CPU时间、内存和I/O都能的都充分利用，并且确保没有用户使用超出其权限意外的资源

#### 1.1.2 系统视角

可以加操作系统看做资源分配器，计算机系统可能有许多资源，操作系统必须决定如何为各个程序和用户分配 资源，以便计算机系统能有效且公平的运行。

#### 1.1.3 定义操作系统

一种简单的观点是操作系统包括当你预定一个操作系统时零售商所装的所有东西

另一个比较公认的观点是操作系统时一直运行在计算机上的程序（**通常成为内核**）

### 1.2 计算机系统组织

#### 1.2.1计算机系统操作

打开电脑的电源时需要运行一个初始化程序或**引导程序**，比较简单通常位于ROM或EEPROM称为计算机硬件中的固件。它初始化系统中的所有部分，引导系统必须知道如何装入操作系统并执行操作系统。

事件的发生通常通过硬件或软件**中断**来表示。硬件UI是通过系统总线向CPU发出信号触发中断，软件执行特殊的操作，**如系统调用**引发中断。

当CPU中断时它暂停正在做的事立即转到固定位置继续执行，该固定位置通常是中断服务程序的开始位置。

中断必须将控制转移到合适的中断处理程序。比较简单的方法使调用一个子程序检查中断信息，然后该子程序会调用相应的中断处理程序。但是这样的比较慢，所以可以使用中断处理子程序的指针表，这样通过指针表可以调用中断处理子程序而不需要通过其他中间子程序。通常指针表位于低地址内存。这些位置包含各种设备的中断处理子程序的地址。这种地址的数组或**中断向量**可以通过唯一设备号来索引以提供设备的中断处理子程序的地址。

中断体系结构也保存被中断指令的地址。如果中断处理程序需要修改寄存器的值必须保存当前寄存器的值并且在返回之前恢复它。

#### 1.2.2 存储结构

计算机程序必须放在内存中以便于运行，通常用DRAM（动态随机访问内存）技术来实现，是一组内存字的数组，每个字都有其地址。通过对特定内存地址执行load和store来实现交互。

一个典型的指令执行周期：从内存中取指令→获取操作数或价格操作数存在寄存器中→对操作数执行→结果存回到内存

内存太小，程序和数据无法永久驻留在内存中，因此绝大多数计算机系统提供**辅存**。各种存储系统的差别主要是速度、价格、大小、易失性。

#### 1.2.3 I/O结构

通用计算机系统由一个CPU和多个设备控制器组成，他们通过共同的总线连接，每个设备控制器负责特定类型的设备。

例如从键盘中读取一个字符：控制器开始从设备向本地缓冲区传输数据，一旦完成数据传输设备控制器会通过中断通知设备驱动程序已完成操作，然后设备驱动程序返回对操作系统的控制，如果是读操作可能将数据或数据的指针返回。

对于大块的数据移动通过**DMA直接内存访问**。设置好缓冲、指针和计数器后设备控制器能在本地缓冲和内存之间传送一整块数据而无需CPU的干预，每块只产生一个中断来告知操作已完成。

在一些高端系统采用交换而不是总线结构，多个部件可以与其他部件并发对话而不是在公共总线上争夺周期。此时DMA更为有效。

### 1.3 计算机系统体系结构

#### 1.3.1 单处理器系统

绝大多数系统采用单处理器系统。由一个主CPU执行通用指令集+其他特定目的的处理器（运行一个受限指令集，并不运行用户进程）

#### 1.3.2 多处理器系统

这类系统有多个紧密通信的CPU，共享计算机总线、始终、内存、外存。

优点：增加吞吐量；规模经济（省钱）；增加可靠性（当一个系统出现故障剩下系统可以负担起它的工作）。

非对称多处理器：一个主处理器和多个从处理器，从处理器向主处理器要任务。

对称多处理器（SMP）：N个CPU可以运行N个进程

#### 1.3.3 集群系统

集群系统将多个CPU集中起来完成计算任务。与多处理器系统的区别：集群系统有两个或多个独立系统耦合起来。通常用于提供**高可用性服务**。集群系统可以是对称的也可以是非对称的。**非对称集群**中，一台处于热备份模式另一台运行应用程序。热备份主机监视活动服务器，如果服务器失效热备份主机替代服务器。**对称集群**中，两个或多个主机都运行应用程序。

集群允许多个主机访问共享存储上的相同数据但绝大多数操作系统不支持多个主机同时访问数据。于是出现了分布式锁管理（DLM）服务以确保不发生冲突操作。

### 1.4 操作系统结构

多道程序设计：操作系统同时将多个任务保存在内存中，操作系统选择一个位于内存中的作业并开始执行，当该作业需要等待时CPU会切换到另一作业，只要有任务存在CPU就不会空闲。

分时系统：多道程序系统的延伸。CPU在多个作业中来回切换执行，由于切换频率很高用户可以在运行期间与之交互。分时操作系统允许多个用户共享计算机，并且感觉整个系统为自己所用。每个用户在内存中至少有一个程序，装入内存中的程序称为**进程**。分时系统和多道程序系统在存储器中同时保存几个作业，由于主存较小不能容纳过多所以这些作业存储在**作业池**中。当多个作业需要调入内存而没有内存操作系统必须在从作业池中选择一个作业，这种策略叫**作业调度**。多个任务需要同时执行系统必须做出选择，这样的选择叫做**CPU调度**。

分时操作系统为了保证合理的响应时间会通过交换将进程换入内存、将内存换出到硬盘。实现这一目的更常用的方法使**虚拟内存**。虚拟内存可以比内存大而且使用逻辑内存可以使程序员不必担心内存空间。

### 1.5 操作系统的操作

#### 1.5.1 双重模式操作

为确保操作系统正常执行，必须区分操作系统代码和用户代码。至少需要两种独立的操作模式：用户模式和监督程序模式。开始时用户在用户模式下执行用户进程，一旦出现陷阱或中断，硬件会从用户模式切换至内核模式（将模式位设为0）

#### 1.5.2 定时器

为了维持操作系统对CPU的控制、防止用户程序陷入死循环等问题，使用**定时器**。在给定时间后中断计算机

### 1.6 进程管理

处于执行中的程序叫进程。程序本省并不是进程，程序是被动的实体而进程是实体。单线程进程有程序计数器来明确下一执行的指令

操作系统负责的活动：创建和删除用户进程和系统进程、挂起和重启进程、提供进程同步机制、提供进程通信机制、提供死锁处理机制。

### 1.7 内存管理

操作系统负责的活动：记录内存的那部分正在被使用以及被谁使用、当内存有空间时决定哪些进程可以装入内存、根据需要分配和释放内存。

### 1.8 存储管理

#### 1.8.1 文件系统管理

操作系统负责的活动：创建和删除文件、创建和删除目录来组织文件、提供操作文件和目录的原语、将文件映射到二级存储上、在稳定存储介质上备份文件。

#### 1.8.2 大容量存储器管理

操作系统负责的活动：空闲空间管理、存储空间分配、硬盘调度

#### 1.8.3 高速缓存

当需要特定信息时，首先检查是否位于高速缓存，否则使用内存中的信息。

问题：高速缓存一致性。

#### 1.8.4 I/O系统

操作系统目的在于对用户隐藏具体设备的特性。

### 1.9 保护和安全

计算机系统如果允许多个用户或者多个进程并发进行必须系统地管理对数据的访问。只有从操作系统中获得了恰当的授权进程才可以操作相应文件、内存段、CPU和其他资源。

### 1.10 分布式系统

分布式系统时一种**物理上分开的、各种可能异构的、通过网络连接在一起、为用户提供各种资源的**计算机的集合。

网络操作系统提供跨网络的文件共享、不同计算机上的进程进行信息交换的通信方法等功能。

### 1.11 专用系统

#### 1.11.1实时嵌入式系统

嵌入式系统运行**实时操作系统**。实时系统有明确而固定的时间约束。

#### 1.11.2 多媒体系统

最近的技术发展趋势将多媒体数据加入到计算机系统中。

#### 1.11.3 手持系统

**手持系统**包括个人数字助理（PDA），其中许多都使用专门的嵌入式操作系统。

### 1.12 计算环境

#### 1.12.1 传统计算

#### 1.12.2 客户机-服务器计算

服务器系统可大致分为计算服务器和文件服务器：

计算服务器系统提供了一个接口，以接受用户所发送的请求。

文件服务系统提供文件系统接口，以便客户机创建、更新、访问和删除文件。

#### 1.12.3 对等计算

分布式系统的另一种结构是对等（P2P）系统模式。客户机和服务器彼此并不区别，系统中的所有节点都是对等的，每一个可作为客户机或服务器。

#### 1.12.4 基于web的计算

出现了新一类的设备，如**负载均衡器**，它能在一组相似的服务器之间实现负荷分配。